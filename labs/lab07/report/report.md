---
## Front matter
title: "Лабораторная работа № 7"
subtitle: " Адресация IPv4 и IPv6.Настройка DHCP"
author: "Андреева Софья Владимировна"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: false # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a4
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: PT Serif
romanfont: PT Serif
sansfont: PT Sans
monofont: PT Mono
mainfontoptions: Ligatures=TeX
romanfontoptions: Ligatures=TeX
sansfontoptions: Ligatures=TeX,Scale=MatchLowercase
monofontoptions: Scale=MatchLowercase,Scale=0.9
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Цель работы

Получение навыков настройки службы DHCPна сетевом оборудовании для распределения адресов IPv4 и IPv6.

# Выполнение лабораторной работы

**7.3. Задания для выполнения**

**7.3.1. Настройка DHCP в случае IPv4**

**7.3.1.1. Постановка задачи**

Мне задана топология сети и сведения по адресному пространству сети.

Требуется настроить на маршрутизаторе, имеющем адрес 10.0.0.1, DHCP-сервис по распределению IPv4-адресов из диапазона 10.0.0.2–10.0.0.253, настроить получение адреса по DHCP на узле (PC), а также исследовать пакеты DHCP.

**7.3.1.2. Порядок выполнения работы**

1.  Я запущу GNS3 VM и GNS3. Создам новый проект.

![новый проект](image/1.png){#fig:001 width=70%}

2.  В рабочем пространстве я размещу и соединю устройства в соответствии с топологией Я буду использовать маршрутизатор VyOS и хост (клиент) VPCS.
3.  Я изменю отображаемые названия устройств. Коммутаторам я присвою названия по принципу `svandreeva-sw-0x`, маршрутизаторам — по принципу `svandreeva-gw-0x`, VPCS — по принципу `PCx-svandreeva`, где  я укажу имя своей учётной записи, вместо `x` — порядковый номер устройства.
4.  Я включу захват трафика на соединении между коммутатором sw-01 и маршрутизатором gw-01.

![захват трафика](image/2.png){#fig:002 width=70%}

5.  **Настройка VyOS:**
    *   Я настрою образ VyOS (для входа в систему я использую логин `vyos` и пароль `vyos`).
    *   На маршрутизаторах я перейду в режим конфигурирования, изменю имя устройства и доменное имя, заменю системного пользователя, заданного по умолчанию, на своего пользователя, вместо `<mysecurepassword>` — пароль для доступа к устройству, например, 123456:

![установка имени](image/3.png){#fig:003 width=70%}



После этого я выполню вход под созданным пользователем и удалю пользователя `vyos`:
      ```
        svandreeva-gw-01 login: svandreeva
        Password:
        svandreeva@svandreeva-gw-01:~$ configure
        svandreeva@svandreeva-gw-01# delete system login user vyos
        svandreeva@svandreeva-gw-01# commit
        svandreeva@svandreeva-gw-01# save
      ```
![сохранение и удаление](image/4.png){#fig:004 width=70%}


6.  На маршрутизаторе, под созданным пользователем в режиме конфигурирования, я настрою адресацию IPv4:

7.  Я добавлю конфигурацию DHCP-сервера на маршрутизаторе:

![добавление конфигурации](image/7.png){#fig:007 width=70%}

![добавление конфигурации](image/8.png){#fig:008 width=70%}

    При помощи указанных команд я создала разделяемую сеть (`shared-network-name`) с названием `svandreeva`, подсеть (`subnet`) с адресом `10.0.0.0/24` и задал диапазон адресов (`range`) с именем `hosts`, содержащий адреса `10.0.0.2–10.0.0.253`.

8.  Для просмотра статистики DHCP-сервера и выданных адресов я буду использовать команды:

![просмотр статистики](image/9.png){#fig:009 width=70%}

Данные скриншоты показывают состояние DHCP-сервера **до** того, как клиент получил адрес. 

На первом скриншоте команды `show dhcp server statistics` и `show dhcp server leases` выполняются сразу после настройки сервера, но до обращения клиента. Видно, что в пуле `svandreeva` доступно 252 адреса (весь диапазон 10.0.0.2–10.0.0.253), но количество выданных аренд (`Leases`) равно 0, а статистика использования (`Usage`) показывает 0%. Ниже, в выводе команды показа аренд, таблица пуста, так как ни один адрес еще не был выдан. 

9.  Я настрою оконечное устройство PC1:

![настройка оконечного устройства](image/10.png){#fig:011 width=70%}

![настройка оконечного устройства](image/11.png){#fig:012 width=70%}

Здесь я использовала опцию `-d` для обеспечения возможности просмотра декодированных запросов DHCP.

10. Я проверю конфигурацию IPv4 на узле и пропингую маршрутизатор:
    ```bash
    PC1-svandreeva> show ip
    PC1-svandreeva> ping 10.0.0.1 -c 2
    ```
![проверка конфигурации и пинг ](image/12.png){#fig:013 width=70%}

Эти скриншоты подтверждают успешную работу DHCP.

На первом  команда `show ip` на клиенте VPCS показывает, что он получил от сервера `10.0.0.1` полную конфигурацию: IP-адрес `10.0.0.2/24`, шлюз, DNS и доменное имя. Также указано время аренды адреса (`DHCP LEASE`).

На втором успешный `ping` с клиента на адрес шлюза `10.0.0.1` доказывает, что сетевые настройки применены корректно и связь на канальном и сетевом уровнях установлена. Клиент полностью работоспособен в сети.

11. На маршрутизаторе я вновь посмотрю статистику DHCP-сервера и выданные адреса:
    ```bash
    svandreeva@svandreeva-gw-01$ show dhcp server statistics
    svandreeva@svandreeva-gw-01$ show dhcp server leases
    ```

![просмотр статистики](image/14.png){#fig:015 width=70%}

Команда show dhcp server statistics теперь отображает: в пуле svandreeva из 252 адресов выдана одна аренда (Leases: 1), доступно 251, использование (Usage) — около 0.4%.

Команда show dhcp server leases выводит детали этой аренды: клиент с MAC-адресом 00:50:79:66:68:00 (сокращённо в выводе) получил IP-адрес 10.0.0.2. Указано время начала аренды (Lease start) и её окончания (Lease expiration), а также имя хоста (Hostname) — VPCS1. Это доказывает, что сервер успешно выполнил свою работу и отслеживает выданные адреса.

12. На маршрутизаторе я посмотрю журнал работы DHCP-сервера:
    ```bash
    svandreeva@svandreeva-gw-01$ show log | grep dhcp
    ```

![просмотр журнала работы](image/15.png){#fig:016 width=70%}

Выполнив команду `show log | grep dhcp`, я проанализировала журнал DHCP. В логах обнаружены многочисленные повторяющиеся записи об удалении DNS-серверов и доменов поиска, полученных через DHCP для интерфейса `eth0`. Эти действия выполняются скриптом `dhclient-script-vyos` и службой `vyos-hostsd`. Такая циклическая активность DHCP-клиента, постоянно обновляющего настройки DNS, может указывать на частое обновление аренды DHCP.

13. В отчёте я проанализирую захваченные анализатором трафика пакеты, относящиеся к работе DHCP и назначению адреса устройству.

![анализ трафика](image/16.png){#fig:017 width=70%}

![анализ трафика](image/17.png){#fig:018 width=70%}

Анализ захвата трафика в Wireshark наглядно демонстрирует классический четырёхэтапный процесс DORA получения адреса по DHCPv4. Инициацию процесса выполняет клиент, отправляя широковещательный пакет DHCP Discover со своим MAC-адресом. В ответ сервер направляет DHCP Offer, предлагая конкретный адрес (10.0.0.2), шлюз, маску подсети и DNS-сервер. Клиент подтверждает выбор этого предложения, отправляя DHCP Request, после чего сервер финализирует процесс, отправляя подтверждение DHCP ACK, которое завершает аренду адреса. Перед отправкой предложения сервер проверяет доступность адреса через ARP-запросы, а после получения ACK клиент выполняет Gratuitous ARP, объявляя свой новый IP-адрес в сети для предотвращения конфликтов. Весь захваченный обмен пакетами подтверждает корректную и последовательную работу протокола DHCPv4 на всех этапах.

**7.3.2. Настройка DHCP в случае IPv6**

**7.3.2.1. Постановка задачи**

Мне задана топология сети и сведения по адресному пространству.

Требуется:
*   На интерфейсе маршрутизатора `eth1` настроить DHCPv6 без отслеживания состояния.
*   На интерфейсе маршрутизатора `eth2` настроить DHCPv6 с учётом отслеживания состояния.

**7.3.2.2. Порядок выполнения работы**

1.  В предыдущем проекте, в рабочем пространстве, я дополню сеть, размещу и соединю устройства в соответствии с топологией. Я буду использовать хост (клиент) Kali Linux CLI (добавлю образ Kali Linux CLI в перечень устройств в GNS3), поскольку клиент VPCS не поддерживает DHCPv6.
2.  Я изменю отображаемые названия устройств. Коммутаторам присвою названия по принципу `svandreeva-sw-0x`, маршрутизаторам — по принципу `svandreeva-gw-0x`, Kali Linux CLI — по принципу `PCx-svandreeva`, где вместо `svandreeva` укажу имя своей учётной записи, вместо `x` — порядковый номер устройства.
3.  Я включу захват трафика на соединениях между маршрутизатором `gw-01` и коммутаторами `sw-02` и `sw-03`.

![создание проекта](image/28.png){#fig:029 width=70%}

4.  На маршрутизаторе я настрою адресацию IPv6:

![настройка адресации](image/29.png){#fig:030 width=70%}


5.  **Настройка DHCPv6 без отслеживания состояния (Stateless):**
    *   Я настрою объявления о маршрутизаторах (Router Advertisements, RA) на интерфейсе `eth1`:

        Опция `other-config-flag` означает, что для конфигурации неадресных параметров (например, DNS) хост будет использовать протокол DHCPv6.
    *   Я добавлю конфигурацию DHCP-сервера       

![добавление конфигурации](image/31.png){#fig:032 width=70%}

![просмотр конфигурации](image/32.png){#fig:033 width=70%}

Настройки NTP: Показано, что для синхронизации времени настроены три сервера (time1.vyos.net, time2.vyos.net, time3.vyos.net).

Настройки Syslog (системного журнала): Определена глобальная политика логирования:

Для всех источников (facility all) установлен минимальный уровень логирования info.

Для источников, связанных с сетевыми протоколами (facility protocols), установлен более детальный уровень debug.

С помощью этих команд я создала разделяемую сеть (`shared-network-name`) с названием `svandreeva-stateless` и задал общие опции (`common-options`) для нее. Подсеть `2000::/64` здесь не будет содержать информации о пуле адресов.

6.  На узле PC2 я проверю настройки сети:
    ```bash
    root@PC2-svandreeva:/# ifconfig
    root@PC2-svandreeva:/# route -n -A inet6
    ```

![проверка настроек сети](image/36.png){#fig:037 width=70%}

![проверка настроек сети](image/35.png){#fig:036 width=70%}

Команда ifconfig:

На интерфейсе eth0 виден глобальный IPv6-адрес 2000::42:71ff:fe9e:9200, автоматически сгенерированный по протоколу SLAAC (виден префикс 2000::/64 от маршрутизатора).

Также есть link-local адреса (fe80::...) на интерфейсах eth0 и eth1.

IPv4-адреса отсутствуют, что соответствует задаче работы только с IPv6.

Команда route -n -A inet6:

В таблице маршрутизации есть маршрут в сеть 2000::/64 через интерфейс eth0.

Настроен маршрут по умолчанию (::/0) через link-local адрес шлюза (fe80::ef3:28ff:fe95:1), который был получен из RA-объявлений маршрутизатора.

Прописаны локальные и широковещательные маршруты.

Вывод: Конфигурация показывает, что узел PC2 успешно получил глобальный IPv6-адрес методом SLAAC и маршрут по умолчанию от маршрутизатора, что соответствует настройке Stateless DHCPv6 на сегменте сети 2000::/64.

7.  На узле PC2 я пропингую маршрутизатор:
    ```bash
    root@PC2-svandreeva:/# ping 2000::1 -c 2
    ```

![пинг](image/37.png){#fig:038 width=70%}

Пинг успешно проходит, отправлено 2 пакета

8.  На узле PC2 я проверю настройки DNS:
    ```bash
    root@PC2-svandreeva:/# cat /etc/resolv.conf
    ```

![проверка настроек](image/38.png){#fig:039 width=70%}

Команда cat /etc/resolv.conf показывает, что файл с настройками DNS полностью пуст. Это означает, что на узле PC2 ещё не настроены DNS-серверы, что соответствует текущему этапу — адрес и маршруты получены через SLAAC, но дополнительная конфигурация (включая DNS) должна быть запрошена через DHCPv6.

9.  На узле PC2 я получу информацию по DHCPv6 (без запроса адреса):
    ```bash
    root@PC2-svandreeva:/# dhclient -6 -S -v eth0
    ```

![получим информацию](image/39.png){#fig:040 width=70%}

Запустив команду dhclient -6 -S -v eth0, я запустила процесс DHCPv6 в stateless-режиме для получения дополнительной конфигурации. Клиент сгенерировал DUID, отправил запрос Information-Request и получил ответ Reply от сервера с link-local адреса маршрутизатора (fe80::ef3:28ff:fe95:1), после чего процесс успешно завершился. Это означает, что DHCPv6-сервер корректно обработал запрос и передал клиенту неадресные параметры, такие как DNS-серверы и домен поиска, в соответствии с настройкой stateless-режима.
Здесь опция `-6` указывает на использование протокола DHCPv6, опция `-S` — на запрос только информации DHCPv6 (не адреса), опция `-v` — на вывод на экран подробной информации.
10. Я вновь пропингую от узла PC2 маршрутизатор и проверю настройки DNS:
    ```bash
    root@PC2-svandreeva:/# ping 2000::1 -c2
    root@PC2-svandreeva:/# cat /etc/resolv.conf
    ```

![пинг и проверка настроек](image/40.png){#fig:041 width=70%}

Ping: Успешный ping на адрес шлюза 2000::1 подтверждает работоспособность сетевого подключения и корректность маршрута.

Файл /etc/resolv.conf: Теперь он содержит настройки, полученные от DHCPv6-сервера:

Домен поиска: svandreeva.net.

DNS-сервер: 2000::1 (адрес маршрутизатора).

Вывод: DHCPv6 в Stateless-режиме сработал корректно. Клиент получил IPv6-адрес через SLAAC, а дополнительную информацию (DNS) — через DHCPv6, что полностью соответствует поставленной задаче. Сетевая конфигурация узла завершена.

11. На маршрутизаторе я посмотрю статистику DHCP-сервера и выданные адреса:
    ```bash
    svandreeva@svandreeva-gw-01# run show dhcpv6 server leases
    ```

![просмотр статистики](image/40.1.png){#fig:042 width=70%}

Команда show dhcpv6 server leases показывает, что таблица выданных DHCPv6 аренд пуста. На данном этапе это корректный вывод.

12. также проанализирую захваченные анализатором трафика пакеты, относящиеся к работе DHCPv6.

![анализ трафика](image/41.png){#fig:043 width=70%}

![анализ трафика](image/42.png){#fig:044 width=70%}

Анализ захвата трафика показывает начальные этапы процесса IPv6-автоконфигурации в сегменте с настройкой Stateful DHCPv6. Клиент начинает с отправки запроса Router Solicitation для обнаружения маршрутизатора и получения сетевого префикса. Параллельно он отправляет Multicast Listener Report, сообщая о своей готовности получать групповой трафик. Затем наблюдается Neighbor Solicitation, который является частью процедуры DAD (обнаружения дублирования адресов) — клиент проверяет, не занят ли в сети адрес, который он собирается использовать (например, 2000::1). Этот трафик демонстрирует стандартные подготовительные действия IPv6-хоста перед получением полной конфигурации через DHCPv6 в режиме с отслеживанием состояния.

13. **Настройка DHCPv6 с отслеживанием состояния (Stateful):**
    *   На интерфейсе `eth2` маршрутизатора я настрою объявления о маршрутизаторах (Router Advertisements, RA):
       
        Опция `managed-flag` означает, что хосты будут использовать протокол DHCPv6 для получения как адресов, так и другой конфигурации.
    *   Я добавлю конфигурацию DHCP-сервера на маршрутизаторе (вместо `svandreeva` укажу имя своей учётной записи):
       

![добавление конфигурации](image/43.png){#fig:045 width=70%}

Здесь я создала разделяемую сеть (`shared-network-name`) с названием `svandreeva-stateful`, подсеть (`subnet`) с адресом `2001::/64` и задал диапазон адресов, содержащий адреса `2001::100` – `2001::199`.
14. На маршрутизаторе я посмотрю статистику DHCP-сервера и выданные адреса:

![просмотр статистики](image/44.png){#fig:046 width=70%}

Таблица аренд DHCPv6-сервера пуста, что соответствует моменту, когда ни один адрес ещё не был выдан клиенту PC3.

15. Я подключусь к узлу PC3 и проверю настройки сети:

![просмотр настроек](image/45.png){#fig:047 width=70%}

![просмотр настроек](image/45.1.png){#fig:034 width=70%}

Перед запуском DHCP-клиента на интерфейсе eth0 присутствует только link-local адрес (fe80::...). Глобальный IPv6-адрес отсутствует. В таблице маршрутизации есть только маршрут по умолчанию (полученный из RA) и локальные маршруты.

16. На узле PC3 я проверю настройки DNS:

![просмотр настроек](image/46.png){#fig:048 width=70%}

Файл с настройками DNS пуст, так как дополнительная конфигурация ещё не была получена от DHCPv6-сервера.

17. На узле PC3 я получу адрес и конфигурацию по DHCPv6:

![получение адреса](image/47.png){#fig:049 width=70%}

Вывод команды показывает детальный процесс получения адреса по DHCPv6 (Solicit-Advertise-Request-Reply). Видно, что сервер предложил (Advertise) адрес 2001::199, клиент запросил его (Request), и сервер подтвердил выдачу (Reply), указав время жизни адреса.

18. Я вновь на узле PC3 проверю настройки сети, пропингую маршрутизатор и проверю настройки DNS:

![просмотр настроек](image/48.png){#fig:050 width=70%}

На интерфейсе eth0 виден глобальный IPv6-адрес 2001::199/128, выданный DHCPv6-сервером, и link-local адрес fe80::42:4aff:fe46:2400. Адрес назначен с префиксом /128, что характерно для адреса, полученного от DHCPv6, а не сгенерированного через SLAAC.

![просмотр настроек, пинг](image/49.png){#fig:051 width=70%}

route -n -A inet6: В таблице маршрутизации есть маршрут для выданного адреса (2001::199/128) и маршрут по умолчанию через link-local адрес шлюза.

ping 2001::1 -c 2: Успешный пинг подтверждает корректную сетевую связность.

cat /etc/resolv.conf: Файл содержит DNS-сервер 2001::1 и домен поиска svandreeva.net., полученные от DHCPv6-сервера.

19. На маршрутизаторе я посмотрю статистику DHCP-сервера и выданные адреса:

![просмотр статистики](image/50.png){#fig:052 width=70%}

В таблице аренд появилась активная запись. Сервер зафиксировал выдачу адреса 2001::199 клиенту с определённым DUID, указано время начала аренды и время её окончания. Это доказывает, что сервер работает в stateful-режиме и отслеживает выданные адреса.

20. а также проанализирую захваченные анализатором трафика пакеты, относящиеся к работе DHCPv6 и назначению адреса устройству.

![анализ трафика](image/51.png){#fig:053 width=70%}

![анализ трафика](image/52.png){#fig:054 width=70%}

Анализ захваченного трафика полностью демонстрирует последовательный и корректный процесс назначения IPv6-адреса устройству PC3 по протоколу DHCPv6 в режиме Stateful. Процесс начинается с подготовительных действий клиента в сети: отправки Router Solicitation для обнаружения маршрутизатора и выполнения Neighbor Solicitation в рамках процедуры DAD для проверки уникальности адресов. Основной процесс разворачивается в виде классического четырёхэтапного обмена. Клиент инициирует его, отправляя широковещательный пакет Solicit со своим уникальным идентификатором (DUID) на адрес всех DHCPv6-серверов. В ответ сервер направляет клиенту прямое Advertise-предложение, содержащее конкретный адрес `2001::199` из настроенного пула. Клиент подтверждает выбор этого предложения, отправляя широковещательный Request, после чего сервер финализирует операцию, отправляя Reply. В этом финальном пакете не только окончательно закрепляется аренда адреса `2001::199` с указанием времени жизни, но и передаётся полная дополнительная конфигурация — адрес DNS-сервера (`2001::1`) и домен поиска (`svandreeva.net`). Весь обмен, использующий идентификаторы клиента и сервера, подтверждает работу DHCPv6 именно в stateful-режиме, где сервер активно управляет пулом адресов и отслеживает их аренду, что в итоге и отображается в его таблице выданных адресов.

# Вывод 

Я получила навыки настройки службы DHCP на сетевом оборудовании для распределения адресов  IPv4 и IPv6